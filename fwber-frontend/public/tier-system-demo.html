<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>fwber Tier System Interactive Demo</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 0; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .header { text-align: center; color: white; margin-bottom: 32px; }
    .header h1 { font-size: 42px; margin: 0 0 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .header p { font-size: 18px; opacity: 0.9; margin: 0; }
    
    .auth-panel { 
      background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .auth-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input { padding: 12px 16px; font-size: 14px; border: 2px solid #e1e4e8; border-radius: 8px; }
    input:focus { outline: none; border-color: #667eea; }
    button {
      padding: 12px 20px; font-size: 14px; font-weight: 600; cursor: pointer;
      border: none; border-radius: 8px; transition: all 0.2s;
    }
    button.primary { background: #667eea; color: white; }
    button.primary:hover { background: #5568d3; transform: translateY(-1px); }
    button.secondary { background: #f6f8fa; color: #24292e; }
    button.secondary:hover { background: #e1e4e8; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .status { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .status.logged-out { background: #ffeef0; color: #d73a49; }
    .status.logged-in { background: #dcffe4; color: #22863a; }
    
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    
    .card {
      background: white; border-radius: 16px; padding: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    .card h2 { margin: 0 0 16px; font-size: 24px; color: #24292e; }
    .card h3 { margin: 16px 0 12px; font-size: 18px; color: #586069; }
    
    .tier-badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 16px; border-radius: 20px; font-weight: 600;
      font-size: 16px; margin-bottom: 16px;
    }
    .tier-badge.discovery { background: #ffeaa7; color: #d63031; }
    .tier-badge.matched { background: #74b9ff; color: #0984e3; }
    .tier-badge.chatting { background: #a29bfe; color: #6c5ce7; }
    .tier-badge.dating { background: #fd79a8; color: #e84393; }
    .tier-badge.relationship { background: #55efc4; color: #00b894; }
    
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
    .stat {
      padding: 12px; background: #f6f8fa; border-radius: 8px; text-align: center;
    }
    .stat-value { font-size: 24px; font-weight: 700; color: #667eea; }
    .stat-label { font-size: 12px; color: #586069; margin-top: 4px; }
    
    .photo-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px; margin: 16px 0;
    }
    .photo-card {
      aspect-ratio: 1; background: #f6f8fa; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; border: 2px solid #e1e4e8;
      position: relative; overflow: hidden;
    }
    .photo-card img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .photo-card.blurred img {
      filter: blur(20px);
    }
    .photo-card.ai { border-color: #667eea; background: linear-gradient(135deg, #667eea22, #764ba222); }
    .photo-card.real { border-color: #22863a; background: linear-gradient(135deg, #22863a22, #00b89422); }
    .photo-card.locked {
      background: #fafbfc; border-color: #d1d5da; filter: grayscale(1);
      opacity: 0.5;
    }
    .photo-badge {
      position: absolute; top: 4px; right: 4px;
      background: white; padding: 2px 6px; border-radius: 4px;
      font-size: 10px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .photo-badge.ai { color: #667eea; }
    .photo-badge.real { color: #22863a; }
    
    .unlock-list {
      list-style: none; padding: 0; margin: 12px 0;
    }
    .unlock-list li {
      padding: 8px 12px; margin: 4px 0; background: #f6f8fa;
      border-radius: 8px; display: flex; align-items: center; gap: 8px;
    }
    .unlock-list li::before { content: '‚úì'; color: #22863a; font-weight: 700; }
    
    .log {
      background: #24292e; color: #f6f8fa; padding: 16px;
      border-radius: 8px; font-family: 'Courier New', monospace;
      font-size: 12px; max-height: 300px; overflow-y: auto;
      margin-top: 16px;
    }
    .log-line { margin: 4px 0; }
    .log-line.success { color: #34d399; }
    .log-line.error { color: #f87171; }
    .log-line.info { color: #60a5fa; }
    
    .loading { 
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid #667eea; border-top-color: transparent;
      border-radius: 50%; animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üí´ fwber Tier System</h1>
      <p>Interactive Relationship Progression Demo</p>
    </div>

    <div class="auth-panel">
      <div class="auth-row">
        <input id="email" type="email" value="alice@test.com" placeholder="Email" />
        <input id="password" type="password" value="password123" placeholder="Password" />
        <button class="primary" onclick="login()" id="loginBtn">Login as Alice</button>
        <button class="secondary" onclick="switchUser()" id="switchBtn">Switch to Bob</button>
        <button class="secondary" onclick="logout()" id="logoutBtn" disabled>Logout</button>
        <span id="authStatus" class="status logged-out">Not Logged In</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üéØ Current Tier Status</h2>
        <div id="tierInfo">
          <p style="color: #586069;">Login to view tier information</p>
        </div>
        
        <h3>üìä Relationship Metrics</h3>
        <div class="stat-grid" id="metrics">
          <div class="stat">
            <div class="stat-value">--</div>
            <div class="stat-label">Messages</div>
          </div>
          <div class="stat">
            <div class="stat-value">--</div>
            <div class="stat-label">Days</div>
          </div>
          <div class="stat">
            <div class="stat-value">--</div>
            <div class="stat-label">Met IRL</div>
          </div>
        </div>
        
        <h3>üîì Unlocked Features</h3>
        <ul class="unlock-list" id="unlocks">
          <li style="opacity: 0.5;">Login to see unlocks</li>
        </ul>
      </div>

      <div class="card" id="messageCard" style="display: none;">
        <h2>üí¨ Send a Message</h2>
        <p style="color: #586069; margin: 0 0 16px;">Send messages to progress your relationship tier!</p>
        <div id="blockedBanner" style="display:none; margin-bottom:12px; padding:12px; border-radius:8px; background:#ffeef0; border:2px solid #d73a49; color:#24292e;">
          üö´ Messaging is blocked between you and the other user. Unblock from the Safety panel below.
        </div>
        
        <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
          <textarea 
            id="messageInput" 
            placeholder="Type your message..."
            style="flex: 1; padding: 12px; font-size: 14px; border: 2px solid #e1e4e8; border-radius: 8px; font-family: inherit; resize: vertical; min-height: 80px;"
          ></textarea>
          <button class="primary" onclick="sendMessage()" id="sendBtn" style="padding: 12px 24px;">
            Send ‚úâÔ∏è
          </button>
          <button class="secondary" onclick="sendMultipleMessages(7)" id="turboBtn" style="padding: 12px 16px; font-weight: 700;">
            Turbo: +7 Messages üöÄ
          </button>
          <button class="secondary" onclick="markMetInPerson()" id="meetBtn" style="padding: 12px 16px; font-weight: 700; background: #22863a; color: white;">
            Meet IRL ‚úÖ
          </button>
        </div>
        
        <div id="tierUpgradeAlert" style="margin-top: 16px; padding: 16px; background: #dcffe4; border: 2px solid #22863a; border-radius: 8px; display: none;">
          <strong style="color: #22863a;">üéâ Tier Upgraded!</strong>
          <p id="tierUpgradeText" style="margin: 8px 0 0; color: #24292e;"></p>
        </div>

        <!-- Message History -->
        <div style="margin-top:24px;">
          <h3 style="margin:0 0 12px; font-size:18px; color:#586069; display:flex; align-items:center; gap:8px;">üóÇÔ∏è Conversation History
            <label style="margin-left:auto; display:flex; align-items:center; gap:6px; font-size:12px; background:#f6f8fa; padding:4px 8px; border-radius:6px; cursor:pointer;">
              <input type="checkbox" id="autoReplyToggle" onchange="toggleAutoReply(this.checked)" style="margin:0;" />
              <span>Auto-reply bot</span>
            </label>
          </h3>
          <div id="messageHistory" style="background:#f6f8fa; border:1px solid #e1e4e8; border-radius:8px; max-height:220px; overflow-y:auto; padding:12px; font-size:13px; line-height:1.4; font-family: 'Courier New', monospace;"></div>
        </div>
      </div>

      <div class="card">
        <h2>üñºÔ∏è Photo Gallery</h2>
        <h3>ü§ñ AI-Generated Photos (Always Visible)</h3>
        <div class="photo-grid" id="aiPhotos">
          <div class="photo-card ai locked">
            <span>üé®</span>
            <span class="photo-badge ai">AI</span>
          </div>
          <div class="photo-card ai locked">
            <span>üé®</span>
            <span class="photo-badge ai">AI</span>
          </div>
        </div>
        
        <h3>üì∏ Real Photos (Unlocked by Tier)</h3>
        <div class="photo-grid" id="realPhotos">
          <div class="photo-card real locked">
            <span>üîí</span>
            <span class="photo-badge real">Real</span>
          </div>
          <div class="photo-card real locked">
            <span>üîí</span>
            <span class="photo-badge real">Real</span>
          </div>
          <div class="photo-card real locked">
            <span>üîí</span>
            <span class="photo-badge real">Real</span>
          </div>
          <div class="photo-card real locked">
            <span>üîí</span>
            <span class="photo-badge real">Real</span>
          </div>
          <div class="photo-card real locked">
            <span>üîí</span>
            <span class="photo-badge real">Real</span>
          </div>
        </div>
      </div>
      <!-- Physical Profile & Avatar Card -->
      <div class="card" id="profileCard" style="display:none;">
        <h2>üßç Physical Profile & Avatar</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:end;">
          <div>
            <label style="display:block; font-size:12px; color:#586069;">Height (cm)</label>
            <input id="pp_height_cm" type="number" min="80" max="250" placeholder="e.g., 180" />
          </div>
          <div>
            <label style="display:block; font-size:12px; color:#586069;">Body type</label>
            <input id="pp_body_type" type="text" placeholder="e.g., athletic" />
          </div>
          <div>
            <label style="display:block; font-size:12px; color:#586069;">Hair color</label>
            <input id="pp_hair_color" type="text" placeholder="e.g., brown" />
          </div>
            <div>
            <label style="display:block; font-size:12px; color:#586069;">Eye color</label>
            <input id="pp_eye_color" type="text" placeholder="e.g., green" />
          </div>
          <div>
            <label style="display:block; font-size:12px; color:#586069;">Skin tone</label>
            <input id="pp_skin_tone" type="text" placeholder="e.g., medium" />
          </div>
          <div>
            <label style="display:block; font-size:12px; color:#586069;">Ethnicity</label>
            <input id="pp_ethnicity" type="text" placeholder="optional" />
          </div>
          <div>
            <label style="display:block; font-size:12px; color:#586069;">Facial hair</label>
            <input id="pp_facial_hair" type="text" placeholder="e.g., stubble" />
          </div>
          <div style="display:flex; gap:12px; align-items:center; margin-top:18px;">
            <label style="display:flex; gap:6px; align-items:center; font-size:12px; color:#586069;"><input id="pp_tattoos" type="checkbox"/> Tattoos</label>
            <label style="display:flex; gap:6px; align-items:center; font-size:12px; color:#586069;"><input id="pp_piercings" type="checkbox"/> Piercings</label>
          </div>
          <div>
            <label style="display:block; font-size:12px; color:#586069;">Dominant hand</label>
            <select id="pp_dominant_hand">
              <option value="">(select)</option>
              <option value="left">left</option>
              <option value="right">right</option>
              <option value="ambi">ambi</option>
            </select>
          </div>
          <div>
            <label style="display:block; font-size:12px; color:#586069;">Fitness level</label>
            <select id="pp_fitness_level">
              <option value="">(select)</option>
              <option value="low">low</option>
              <option value="average">average</option>
              <option value="fit">fit</option>
              <option value="athletic">athletic</option>
            </select>
          </div>
          <div>
            <label style="display:block; font-size:12px; color:#586069;">Clothing style</label>
            <input id="pp_clothing_style" type="text" placeholder="e.g., streetwear" />
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display:block; font-size:12px; color:#586069;">Avatar prompt</label>
            <input id="pp_avatar_prompt" type="text" placeholder="Describe your avatar style..." />
          </div>
        </div>
        <div style="display:flex; gap:12px; margin-top:12px;">
          <button class="secondary" onclick="saveProfile()">Save Profile</button>
          <button class="primary" onclick="requestAvatarGen()">Generate Avatar</button>
          <span id="avatarStatus" class="status logged-out" style="display:none;"></span>
        </div>
        <div id="avatarPreview" style="margin-top:12px; display:flex; align-items:center; gap:12px;">
          <div style="width:96px; height:96px; border-radius:12px; border:2px solid #e1e4e8; background:#f6f8fa; display:flex; align-items:center; justify-content:center; overflow:hidden;">
            <img id="avatarImg" src="" alt="avatar" style="display:none; width:100%; height:100%; object-fit:cover;" />
            <span id="avatarPlaceholder" style="font-size:28px; color:#667eea;">üë§</span>
          </div>
          <div id="avatarNote" style="color:#586069; font-size:13px;">No avatar generated yet.</div>
        </div>
      </div>
      <!-- Safety Card -->
      <div class="card" id="safetyCard" style="display:none;">
        <h2>üõ°Ô∏è Safety: Block & Report</h2>
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
          <button class="secondary" id="blockBtn" onclick="blockUser()">Block other user</button>
          <button class="secondary" id="unblockBtn" onclick="unblockUser()" style="display:none;">Unblock</button>
          <span id="blockState" class="status" style="display:none;"></span>
        </div>
        <h3 style="margin-top:0;">üö© Report User</h3>
        <div style="display:grid; gap:8px;">
          <input id="reportReason" type="text" placeholder="Reason (e.g., harassment)" />
          <textarea id="reportDetails" placeholder="Details (optional)" style="min-height:80px; padding:8px; border:2px solid #e1e4e8; border-radius:8px;"></textarea>
          <button class="secondary" onclick="reportUser()">Submit Report</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 24px;">
      <h2>üì° API Activity Log</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:8010/api';
    let token = null;
    let currentUser = 'alice';
    let isBlocked = false;

    function log(msg, type = 'info') {
      const el = document.getElementById('log');
      const line = document.createElement('div');
      line.className = `log-line ${type}`;
      const time = new Date().toLocaleTimeString();
      line.textContent = `[${time}] ${msg}`;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }

    function updateAuthUI() {
      const status = document.getElementById('authStatus');
      const logoutBtn = document.getElementById('logoutBtn');
      const loginBtn = document.getElementById('loginBtn');
      const turboBtn = document.getElementById('turboBtn');
      const meetBtn = document.getElementById('meetBtn');
      
      if (token) {
        status.textContent = `Logged in as ${currentUser === 'alice' ? 'Alice' : 'Bob'}`;
        status.className = 'status logged-in';
        logoutBtn.disabled = false;
        loginBtn.disabled = true;
        if (turboBtn) turboBtn.disabled = false;
        if (meetBtn) meetBtn.disabled = false;
      } else {
        status.textContent = 'Not Logged In';
        status.className = 'status logged-out';
        logoutBtn.disabled = true;
        loginBtn.disabled = false;
        if (turboBtn) turboBtn.disabled = true;
        if (meetBtn) meetBtn.disabled = true;
      }
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      log(`Logging in as ${email}...`);
      
      try {
        const res = await fetch(`${API}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          token = data.token;
          log(`‚úì Login successful! Token: ${token.slice(0, 16)}...`, 'success');
          updateAuthUI();
          document.getElementById('messageCard').style.display = 'block';
          document.getElementById('profileCard').style.display = 'block';
          document.getElementById('safetyCard').style.display = 'block';
          await loadTierData();
          await loadProfile();
          await loadMessages(); // also sets block state
        } else {
          log(`‚úó Login failed: ${data.message}`, 'error');
        }
      } catch (e) {
        log(`‚úó Error: ${e.message}`, 'error');
      }
    }

    function switchUser() {
      currentUser = currentUser === 'alice' ? 'bob' : 'alice';
      const email = currentUser === 'alice' ? 'alice@test.com' : 'bob@test.com';
      document.getElementById('email').value = email;
      document.getElementById('switchBtn').textContent = `Switch to ${currentUser === 'alice' ? 'Bob' : 'Alice'}`;
      log(`Switched to ${currentUser}`);
    }

    async function logout() {
      if (!token) return;
      
      log('Logging out...');
      
      try {
        const res = await fetch(`${API}/auth/logout`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.status === 204) {
          log('‚úì Logged out successfully', 'success');
          token = null;
          updateAuthUI();
          document.getElementById('messageCard').style.display = 'none';
          document.getElementById('profileCard').style.display = 'none';
          document.getElementById('safetyCard').style.display = 'none';
          clearTierData();
          clearProfileUI();
          setBlockedUI(false);
        }
      } catch (e) {
        log(`‚úó Error: ${e.message}`, 'error');
      }
    }

    async function loadTierData() {
      if (!token) return;
      
      log('Loading tier data for match #1...');
      
      try {
        const res = await fetch(`${API}/matches/1/tier`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          }
        });
        
        const data = await res.json();
        
        if (res.ok) {
          log(`‚úì Tier data loaded: ${data.current_tier}`, 'success');
          displayTierData(data);
          await loadPhotos(data);
        } else {
          log(`‚úó Failed to load tier: ${data.message}`, 'error');
        }
      } catch (e) {
        log(`‚úó Error: ${e.message}`, 'error');
      }
    }

    function displayTierData(data) {
      const tierInfo = document.getElementById('tierInfo');
      const { current_tier, tier_info, messages_exchanged, days_connected, has_met_in_person } = data;
      
      tierInfo.innerHTML = `
        <div class="tier-badge ${current_tier}">
          <span>${tier_info.icon}</span>
          <span>${tier_info.name}</span>
        </div>
        <p style="color: #586069; margin: 0;">
          Your relationship has progressed to the <strong>${tier_info.name}</strong> tier!
        </p>
      `;
      
      document.getElementById('metrics').innerHTML = `
        <div class="stat">
          <div class="stat-value">${messages_exchanged}</div>
          <div class="stat-label">Messages</div>
        </div>
        <div class="stat">
          <div class="stat-value">${Math.floor(days_connected)}</div>
          <div class="stat-label">Days</div>
        </div>
        <div class="stat">
          <div class="stat-value">${has_met_in_person ? 'Yes' : 'No'}</div>
          <div class="stat-label">Met IRL</div>
        </div>
      `;
      
      const unlocks = tier_info.unlocks || [];
      document.getElementById('unlocks').innerHTML = unlocks.map(u => `<li>${u}</li>`).join('');
    }

    async function loadPhotos(tierData) {
      if (!token) return;
      
      log('Loading photos...');
      
      try {
        const res = await fetch(`${API}/matches/1/photos`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          }
        });
        
        const data = await res.json();
        
        if (res.ok) {
          const totalVisible = data.ai_photos.length + data.real_photos.visible.length + data.real_photos.blurred.length;
          log(`‚úì Photos loaded: ${totalVisible} visible, ${data.real_photos.locked} locked`, 'success');
          displayPhotos(data);
        } else {
          log(`‚úó Failed to load photos: ${data.message}`, 'error');
        }
      } catch (e) {
        log(`‚úó Error: ${e.message}`, 'error');
      }
    }

    function displayPhotos(data) {
      const aiPhotos = data.ai_photos || [];
      const visibleReal = data.real_photos.visible || [];
      const blurredReal = data.real_photos.blurred || [];
      
      document.getElementById('aiPhotos').innerHTML = aiPhotos.map((p, i) => `
        <div class="photo-card ai">
          <img src="${p.url}" alt="AI Photo ${i + 1}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
          <span style="display: none; font-size: 32px;">üé®</span>
          <span class="photo-badge ai">AI ${i + 1}</span>
        </div>
      `).join('');
      
      // Combine visible and blurred real photos
      const allRealPhotos = [...visibleReal, ...blurredReal];
      const realPhotoHTML = allRealPhotos.map((p, i) => `
        <div class="photo-card real ${p.blurred ? 'blurred' : ''}">
          <img src="${p.url}" alt="${p.blurred ? 'Blurred' : 'Real'} Photo ${i + 1}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
          <span style="display: none; font-size: 32px;">${p.blurred ? 'üå´Ô∏è' : 'üì∏'}</span>
          <span class="photo-badge real">${p.blurred ? 'Blurred' : 'Real'} ${i + 1}</span>
        </div>
      `).join('');
      
      const lockedCount = data.real_photos.locked || 0;
      const lockedHTML = Array(lockedCount).fill(0).map((_, i) => `
        <div class="photo-card real locked">
          <span style="font-size: 32px;">üîí</span>
          <span class="photo-badge real">Locked</span>
        </div>
      `).join('');
      
      document.getElementById('realPhotos').innerHTML = realPhotoHTML + lockedHTML;
    }

    async function sendMessage(contentOverride) {
      if (!token) {
        log('‚úó Please login first', 'error');
        return;
      }
      
      const messageInput = document.getElementById('messageInput');
      const content = (contentOverride ?? messageInput.value).trim();
      
      if (!content) {
        log('‚úó Message cannot be empty', 'error');
        return;
      }
      
      // Determine receiver (if logged in as Alice, send to Bob and vice versa)
      const receiverEmail = currentUser === 'alice' ? 'bob@test.com' : 'alice@test.com';
      const receiverId = currentUser === 'alice' ? 6 : 5; // Bob is user 6, Alice is user 5
      
      log(`Sending message to ${receiverEmail}...`);
      
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="loading"></span>';
      
      try {
        const res = await fetch(`${API}/messages`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            receiver_id: receiverId,
            content: content
          })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          log(`‚úì Message sent! (${data.tier_update.messages_exchanged} total)`, 'success');
          messageInput.value = '';
          
          // Check if tier upgraded
          if (data.tier_update.tier_upgraded) {
            log(`üéâ TIER UPGRADED: ${data.tier_update.previous_tier} ‚Üí ${data.tier_update.current_tier}`, 'success');
            showTierUpgradeAlert(data.tier_update);
          }
          
          // Reload tier data and photos
          await loadTierData();
          // Reload messages
          await loadMessages();
        } else {
          log(`‚úó Failed to send message: ${data.error || data.message}`, 'error');
        }
      } catch (e) {
        log(`‚úó Error: ${e.message}`, 'error');
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = 'Send ‚úâÔ∏è';
      }
    }

    // Load conversation messages
    async function loadMessages() {
      if (!token) return;
      // Receiver is the other user in the match
      const otherUserId = currentUser === 'alice' ? 6 : 5;
      try {
        const res = await fetch(`${API}/messages/${otherUserId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          }
        });
        if (res.status === 403) {
          isBlocked = true;
          setBlockedUI(true);
          log('‚ö†Ô∏è Messaging blocked between users.', 'error');
          return;
        }
        const data = await res.json();
        if (!res.ok) {
            log(`‚úó Failed to load messages: ${data.message || data.error}`, 'error');
            return;
        }
        isBlocked = false;
        setBlockedUI(false);
        const items = data.data || [];
        renderMessageHistory(items);
      } catch (e) {
        log(`‚úó Error loading messages: ${e.message}`, 'error');
      }
    }

    function renderMessageHistory(messages) {
      const container = document.getElementById('messageHistory');
      if (!container) return;
      if (!messages.length) {
        container.innerHTML = '<em style="color:#586069;">No messages yet.</em>';
        return;
      }
      container.innerHTML = messages.map(m => {
        const mine = m.sender_id === (currentUser === 'alice' ? 5 : 6);
        const ts = new Date(m.sent_at).toLocaleTimeString();
        const esc = (str) => str.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
        return `<div style="margin:4px 0; display:flex; ${mine ? 'justify-content:flex-end;' : 'justify-content:flex-start;'}">
          <div style="max-width:70%; padding:8px 10px; border-radius:10px; ${mine ? 'background:#667eea; color:#fff;' : 'background:#e1e4e8; color:#24292e;'}">
            <div style="font-size:11px; opacity:0.7; margin-bottom:2px;">${mine ? 'You' : (currentUser === 'alice' ? 'Bob' : 'Alice')} ‚Ä¢ ${ts}</div>
            <div style="white-space:pre-wrap;">${esc(m.content)}</div>
          </div>
        </div>`;
      }).join('');
      container.scrollTop = container.scrollHeight;
    }

    // Auto-reply bot state
    let autoReplyEnabled = false;
    let autoReplyInFlight = false;

    function toggleAutoReply(enabled) {
      autoReplyEnabled = enabled;
      log(`Auto-reply bot ${enabled ? 'ENABLED' : 'disabled'}.`, enabled ? 'success' : 'info');
    }

    async function maybeAutoReply(lastUserMessage) {
      if (!autoReplyEnabled || autoReplyInFlight) return;
      // Simulate partner reply if we are currentUser sender
      autoReplyInFlight = true;
      try {
        // Instrumentation: verify trigger
        try {
          const preview = (lastUserMessage || '').slice(0, 40);
          log(`Auto-reply trigger received: "${preview}${(lastUserMessage && lastUserMessage.length>40)?'‚Ä¶':''}"`);
        } catch (e) { /* noop */ }
        // Small delay to simulate thinking
        await new Promise(r => setTimeout(r, 600));
        const replyContent = generateAutoReply(lastUserMessage);
        // Temporarily switch user context to send from other side
        const originalUser = currentUser;
        const originalToken = token;
        currentUser = originalUser === 'alice' ? 'bob' : 'alice';
        
        // Need to login as the other user to send from their perspective
        const otherEmail = currentUser === 'alice' ? 'alice@test.com' : 'bob@test.com';
        log(`Auto-reply bot switching to ${currentUser}...`);
        
        const loginRes = await fetch(`${API}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ email: otherEmail, password: 'password123' })
        });
        
        if (loginRes.ok) {
          const loginData = await loginRes.json();
          token = loginData.token;
          await sendMessageDirect(replyContent);
          log(`Auto-reply sent from ${currentUser}!`, 'success');
        }
        
        // Restore original user context
        currentUser = originalUser;
        token = originalToken;
        // Refresh message list from original perspective
        await loadMessages();
      } finally {
        autoReplyInFlight = false;
      }
    }

    // Direct send without triggering auto-reply loop
    async function sendMessageDirect(content) {
      if (!token || !content) return;
      
      const receiverId = currentUser === 'alice' ? 6 : 5;
      
      try {
        const res = await fetch(`${API}/messages`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            receiver_id: receiverId,
            content: content
          })
        });
        
        if (!res.ok) {
          log(`‚úó Auto-reply failed to send`, 'error');
        }
      } catch (e) {
        log(`‚úó Auto-reply error: ${e.message}`, 'error');
      }
    }

    function generateAutoReply(userMessage) {
      const templates = [
        'Got it! üòä',
        'Sounds good to me! üëç',
        'Haha true! üòÑ',
        'Interesting point! ü§î',
        'Let‚Äôs chat more about that soon!',
        'Absolutely agree!',
        'That made me smile üòå',
        'Tell me more!',
      ];
      const pick = templates[Math.floor(Math.random() * templates.length)];
      if (!userMessage) return pick;
      // Light transformation based on user message length
      if (userMessage.length < 20) return pick;
      return pick + ' (' + userMessage.slice(0, 20) + '...)';
    }

    // Hook into sendMessage to trigger auto-reply when enabled
    const originalSendMessage = sendMessage;
    sendMessage = async function(contentOverride) {
      if (isBlocked) {
        log('‚úó Cannot send: users are blocked.', 'error');
        return;
      }
      // Capture the message content before clearing
      const messageContent = contentOverride || document.getElementById('messageInput').value.trim();
      const result = await originalSendMessage(contentOverride);
      // After sending (and reloading) fetch messages and maybe auto reply
      await loadMessages();
      if (autoReplyEnabled && messageContent) {
        log('Auto-reply conditions met; invoking bot‚Ä¶');
        await maybeAutoReply(messageContent);
      }
      return result;
    }

    // ---------- Safety / Block & Report ----------
    function setBlockedUI(blocked) {
      const banner = document.getElementById('blockedBanner');
      const sendBtn = document.getElementById('sendBtn');
      const turboBtn = document.getElementById('turboBtn');
      const meetBtn = document.getElementById('meetBtn');
      const blockBtn = document.getElementById('blockBtn');
      const unblockBtn = document.getElementById('unblockBtn');
      const blockState = document.getElementById('blockState');
      if (!banner) return;
      if (blocked) {
        banner.style.display = 'block';
        sendBtn.disabled = true;
        turboBtn.disabled = true;
        meetBtn.disabled = true;
        blockBtn.style.display = 'none';
        unblockBtn.style.display = 'inline-block';
        blockState.style.display = 'inline-block';
        blockState.className = 'status logged-out';
        blockState.textContent = 'Blocked';
      } else {
        banner.style.display = 'none';
        sendBtn.disabled = false;
        turboBtn.disabled = false;
        meetBtn.disabled = false;
        blockBtn.style.display = 'inline-block';
        unblockBtn.style.display = 'none';
        blockState.style.display = 'none';
      }
    }

    async function blockUser() {
      if (!token) return log('‚úó Login first', 'error');
      const otherUserId = currentUser === 'alice' ? 6 : 5;
      log('Blocking other user...');
      try {
        const res = await fetch(`${API}/blocks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' },
          body: JSON.stringify({ blocked_id: otherUserId })
        });
        const data = await res.json().catch(()=>({}));
        if (res.ok) {
          log('‚úì User blocked', 'success');
          isBlocked = true;
          setBlockedUI(true);
        } else {
          log(`‚úó Block failed: ${data.message || data.error}`, 'error');
        }
      } catch(e){ log(`‚úó Error: ${e.message}`, 'error'); }
    }

    async function unblockUser() {
      if (!token) return log('‚úó Login first', 'error');
      const otherUserId = currentUser === 'alice' ? 6 : 5;
      log('Unblocking other user...');
      try {
        const res = await fetch(`${API}/blocks/${otherUserId}`, {
          method: 'DELETE', headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
        });
        if (res.status === 204 || res.ok) {
          log('‚úì User unblocked', 'success');
          isBlocked = false;
          setBlockedUI(false);
          await loadMessages();
        } else {
          const data = await res.json().catch(()=>({}));
          log(`‚úó Unblock failed: ${data.message || data.error}`, 'error');
        }
      } catch(e){ log(`‚úó Error: ${e.message}`, 'error'); }
    }

    async function reportUser() {
      if (!token) return log('‚úó Login first', 'error');
      const otherUserId = currentUser === 'alice' ? 6 : 5;
      const reason = document.getElementById('reportReason').value.trim();
      const details = document.getElementById('reportDetails').value.trim();
      if (!reason) return log('‚úó Reason required', 'error');
      log('Submitting report...');
      try {
        const res = await fetch(`${API}/reports`, {
          method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`, 'Accept':'application/json'},
          body: JSON.stringify({ reported_user_id: otherUserId, reason, details })
        });
        const data = await res.json();
        if (res.ok) {
          log('‚úì Report submitted', 'success');
          document.getElementById('reportReason').value='';
          document.getElementById('reportDetails').value='';
        } else {
          log(`‚úó Report failed: ${data.message || data.error}`, 'error');
        }
      } catch(e){ log(`‚úó Error: ${e.message}`, 'error'); }
    }

    // ---------- Physical Profile & Avatar ----------
    function collectProfileForm() {
      return {
        height_cm: parseInt(document.getElementById('pp_height_cm').value)||null,
        body_type: document.getElementById('pp_body_type').value||null,
        hair_color: document.getElementById('pp_hair_color').value||null,
        eye_color: document.getElementById('pp_eye_color').value||null,
        skin_tone: document.getElementById('pp_skin_tone').value||null,
        ethnicity: document.getElementById('pp_ethnicity').value||null,
        facial_hair: document.getElementById('pp_facial_hair').value||null,
        tattoos: document.getElementById('pp_tattoos').checked,
        piercings: document.getElementById('pp_piercings').checked,
        dominant_hand: document.getElementById('pp_dominant_hand').value||null,
        fitness_level: document.getElementById('pp_fitness_level').value||null,
        clothing_style: document.getElementById('pp_clothing_style').value||null,
        avatar_prompt: document.getElementById('pp_avatar_prompt').value||null,
      };
    }

    function applyProfileToForm(p){
      if(!p) return;
      const set=(id,val)=>{ if(document.getElementById(id)) document.getElementById(id).value = val ?? ''; };
      set('pp_height_cm', p.height_cm??'');
      set('pp_body_type', p.body_type??'');
      set('pp_hair_color', p.hair_color??'');
      set('pp_eye_color', p.eye_color??'');
      set('pp_skin_tone', p.skin_tone??'');
      set('pp_ethnicity', p.ethnicity??'');
      set('pp_facial_hair', p.facial_hair??'');
      document.getElementById('pp_tattoos').checked = !!p.tattoos;
      document.getElementById('pp_piercings').checked = !!p.piercings;
      set('pp_dominant_hand', p.dominant_hand??'');
      set('pp_fitness_level', p.fitness_level??'');
      set('pp_clothing_style', p.clothing_style??'');
      set('pp_avatar_prompt', p.avatar_prompt??'');
      updateAvatarUI(p);
    }

    function updateAvatarUI(p){
      const statusEl = document.getElementById('avatarStatus');
      const img = document.getElementById('avatarImg');
      const placeholder = document.getElementById('avatarPlaceholder');
      const note = document.getElementById('avatarNote');
      if(!statusEl) return;
      if(!p || !p.avatar_status){
        statusEl.style.display='none';
        img.style.display='none';
        placeholder.style.display='block';
        note.textContent='No avatar generated yet.';
        return;
      }
      statusEl.style.display='inline-block';
      statusEl.textContent = p.avatar_status;
      if(p.avatar_status==='ready' && p.avatar_image_url){
        img.src = p.avatar_image_url;
        img.style.display='block';
        placeholder.style.display='none';
        note.textContent='Avatar ready.';
        statusEl.className='status logged-in';
      } else if(p.avatar_status==='failed') {
        img.style.display='none';
        placeholder.style.display='block';
        note.textContent='Avatar generation failed.';
        statusEl.className='status logged-out';
      } else {
        img.style.display='none';
        placeholder.style.display='block';
        note.textContent='Avatar is generating...';
        statusEl.className='status logged-in';
      }
    }

    async function loadProfile(){
      if(!token) return;
      log('Loading physical profile...');
      try {
        const res = await fetch(`${API}/physical-profile`, { headers:{'Authorization':`Bearer ${token}`, 'Accept':'application/json'} });
        const data = await res.json();
        if(res.ok){
          log('‚úì Profile loaded','success');
          applyProfileToForm(data);
          if(data.avatar_status==='generating') pollAvatarStatus();
        } else {
          log(`‚úó Profile load failed: ${data.message||data.error}`,'error');
        }
      } catch(e){ log(`‚úó Error: ${e.message}`,'error'); }
    }

    async function saveProfile(){
      if(!token) return log('‚úó Login first','error');
      const payload = collectProfileForm();
      log('Saving profile...');
      try {
        const res = await fetch(`${API}/physical-profile`, { method:'PUT', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`,'Accept':'application/json'}, body: JSON.stringify(payload)});
        const data = await res.json();
        if(res.ok){ log('‚úì Profile saved','success'); applyProfileToForm(data); }
        else log(`‚úó Save failed: ${data.message||data.error}`,'error');
      } catch(e){ log(`‚úó Error: ${e.message}`,'error'); }
    }

    async function requestAvatarGen(){
      if(!token) return log('‚úó Login first','error');
      const prompt = document.getElementById('pp_avatar_prompt').value.trim();
      if(!prompt) return log('‚úó Avatar prompt required','error');
      log('Requesting avatar generation...');
      try {
        const res = await fetch(`${API}/physical-profile/avatar/request`, { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`,'Accept':'application/json'} });
        const data = await res.json();
        if(res.ok){ log('‚úì Avatar generation started','success'); applyProfileToForm(data); pollAvatarStatus(); }
        else log(`‚úó Avatar request failed: ${data.message||data.error}`,'error');
      } catch(e){ log(`‚úó Error: ${e.message}`,'error'); }
    }

    async function pollAvatarStatus(){
      for(let i=0;i<30;i++){ // up to ~60s if 2s interval
        await new Promise(r=>setTimeout(r,2000));
        if(!token) return;
        try {
          const res = await fetch(`${API}/physical-profile`, { headers:{'Authorization':`Bearer ${token}`, 'Accept':'application/json'} });
          const data = await res.json();
          if(res.ok){
            applyProfileToForm(data);
            if(data.avatar_status==='ready' || data.avatar_status==='failed') { break; }
          }
        } catch(e){ log(`‚úó Poll error: ${e.message}`,'error'); }
      }
    }

    function clearProfileUI(){
      applyProfileToForm(null);
    }

    async function sendMultipleMessages(count) {
      if (!token) {
        log('‚úó Please login first', 'error');
        return;
      }
      const turboBtn = document.getElementById('turboBtn');
      turboBtn.disabled = true;
      log(`Turbo sending ${count} messages...`);
      for (let i = 0; i < count; i++) {
        await sendMessage(`Turbo message ${i + 1} üöÄ`);
        // Small delay to keep UI readable
        await new Promise(r => setTimeout(r, 200));
      }
      log('Turbo complete!', 'success');
      turboBtn.disabled = false;
    }

    async function markMetInPerson() {
      if (!token) {
        log('‚úó Please login first', 'error');
        return;
      }
      
      const meetBtn = document.getElementById('meetBtn');
      meetBtn.disabled = true;
      log('Marking as met in person...');
      
      try {
        const res = await fetch(`${API}/matches/1/tier/update`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            mark_met_in_person: true
          })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          log(`‚úì Met in person marked!`, 'success');
          
          if (data.tier_upgraded) {
            log(`üéâ TIER UPGRADED: ${data.previous_tier} ‚Üí ${data.current_tier}`, 'success');
            showTierUpgradeAlert(data);
          }
          
          await loadTierData();
        } else {
          log(`‚úó Failed: ${data.error || data.message}`, 'error');
        }
      } catch (e) {
        log(`‚úó Error: ${e.message}`, 'error');
      } finally {
        meetBtn.disabled = false;
      }
    }

    function showTierUpgradeAlert(tierUpdate) {
      const alert = document.getElementById('tierUpgradeAlert');
      const text = document.getElementById('tierUpgradeText');
      
      text.innerHTML = `You've progressed from <strong>${tierUpdate.previous_tier}</strong> to <strong>${tierUpdate.current_tier}</strong>! More photos have been unlocked. üéâ`;
      
      alert.style.display = 'block';
      
      setTimeout(() => {
        alert.style.display = 'none';
      }, 5000);
    }

    function clearTierData() {
      document.getElementById('tierInfo').innerHTML = '<p style="color: #586069;">Login to view tier information</p>';
      document.getElementById('metrics').innerHTML = `
        <div class="stat"><div class="stat-value">--</div><div class="stat-label">Messages</div></div>
        <div class="stat"><div class="stat-value">--</div><div class="stat-label">Days</div></div>
        <div class="stat"><div class="stat-value">--</div><div class="stat-label">Met IRL</div></div>
      `;
      document.getElementById('unlocks').innerHTML = '<li style="opacity: 0.5;">Login to see unlocks</li>';
      document.getElementById('aiPhotos').innerHTML = `
        <div class="photo-card ai locked"><span>üé®</span><span class="photo-badge ai">AI</span></div>
        <div class="photo-card ai locked"><span>üé®</span><span class="photo-badge ai">AI</span></div>
      `;
      document.getElementById('realPhotos').innerHTML = Array(5).fill(0).map(() => `
        <div class="photo-card real locked"><span>üîí</span><span class="photo-badge real">Real</span></div>
      `).join('');
    }

    // Initialize
    updateAuthUI();
    log('Demo ready! Login as Alice or Bob to see tier system in action.', 'info');
  </script>
</body>
</html>
