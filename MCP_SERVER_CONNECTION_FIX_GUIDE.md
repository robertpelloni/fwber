# üîß MCP SERVER CONNECTION FIX GUIDE

**Date:** January 19, 2025  
**Issue:** MCP servers (zen, serena, chroma) connection failures  
**Status:** Gemini CLI working ‚úÖ | Zen MCP Server API key failing ‚ùå

---

## üéØ SITUATION ANALYSIS

### ‚úÖ **WORKING:**
- **Gemini CLI**: Successfully logged in and ready
- **Grok-4**: Working through Zen MCP
- **Codex CLI**: Working

### ‚ùå **NOT WORKING:**
- **Zen MCP Server**: Connection closed error
- **Serena**: Connection closed error
- **Chroma Knowledge**: Connection closed error
- **Gemini API through Zen MCP**: Invalid API key (different from CLI)

---

## üîç ROOT CAUSE

The **Gemini CLI** and **Zen MCP Server** use **different configuration files**:

- **Gemini CLI**: Uses `~/.config/gemini/` or similar
- **Zen MCP Server**: Uses environment variables or its own config

The MCP servers are likely crashing on startup due to missing/invalid API keys.

---

## üõ†Ô∏è FIX MCP SERVER CONNECTIONS

### **Step 1: Check Zen MCP Server Configuration**

The Zen MCP server likely reads API keys from environment variables. Check your `mcp.json` configuration:

**Location:** `C:\Users\hyper\.cursor\mcp.json`

**Expected format:**
```json
{
  "mcpServers": {
    "zen-mcp-server": {
      "command": "npx",
      "args": ["-y", "@openrouter/zen-mcp-server"],
      "env": {
        "GEMINI_API_KEY": "YOUR_GEMINI_KEY_HERE",
        "OPENAI_API_KEY": "YOUR_OPENAI_KEY_HERE",
        "XAI_API_KEY": "YOUR_GROK_KEY_HERE",
        "OPENROUTER_API_KEY": "YOUR_OPENROUTER_KEY_HERE"
      }
    }
  }
}
```

### **Step 2: Set System Environment Variables**

**Option A: PowerShell (Temporary - Current Session)**
```powershell
$env:GEMINI_API_KEY = "YOUR_GEMINI_KEY_HERE"
$env:OPENAI_API_KEY = "YOUR_OPENAI_KEY_HERE"
$env:XAI_API_KEY = "YOUR_GROK_KEY_HERE"
$env:OPENROUTER_API_KEY = "YOUR_OPENROUTER_KEY_HERE"
```

**Option B: PowerShell (Permanent - User Level)**
```powershell
[Environment]::SetEnvironmentVariable("GEMINI_API_KEY", "YOUR_GEMINI_KEY_HERE", "User")
[Environment]::SetEnvironmentVariable("OPENAI_API_KEY", "YOUR_OPENAI_KEY_HERE", "User")
[Environment]::SetEnvironmentVariable("XAI_API_KEY", "YOUR_GROK_KEY_HERE", "User")
[Environment]::SetEnvironmentVariable("OPENROUTER_API_KEY", "YOUR_OPENROUTER_KEY_HERE", "User")
```

**Option C: System Environment Variables (GUI)**
1. Windows Search: "Environment Variables"
2. Click "Environment Variables..."
3. Under "User variables", click "New"
4. Add each API key

### **Step 3: Restart Cursor/IDE**

After setting environment variables:
1. **Close Cursor completely**
2. **Reopen Cursor**
3. MCP servers should reconnect automatically

### **Step 4: Verify MCP Server Status**

Check Cursor's output panel for MCP server status:
- Look for "MCP server started" messages
- Check for any error messages

---

## üîë WHERE TO GET API KEYS

### **Gemini (Google):**
- Visit: https://ai.google.dev/
- Click "Get API Key"
- Copy key (starts with "AIza...")

### **OpenAI:**
- Visit: https://platform.openai.com/api-keys
- Create new secret key
- Copy key (starts with "sk-...")

### **Grok (X.AI):**
- Visit: https://console.x.ai/
- Generate API key
- Copy key

### **OpenRouter:**
- Visit: https://openrouter.ai/keys
- Create new API key
- Copy key

---

## üöÄ ALTERNATIVE: Use Gemini CLI Instead

Since **Gemini CLI is working**, you can use it directly:

```powershell
# Test Gemini CLI
gemini "What is 2+2?"

# Use in development
gemini "Analyze this code: [paste code]"
```

---

## üéØ RECOMMENDED WORKFLOW

**Until MCP servers are fixed:**

1. **Use Grok-4** through Zen MCP (working)
2. **Use Gemini CLI** directly (working)
3. **Use Codex CLI** directly (working)
4. **Use Serena/Chroma** if connection issues resolve

**After fixing environment variables:**

1. **Restart Cursor**
2. **Retest all MCP servers**
3. **Resume full multi-AI orchestration**

---

## üîç DEBUGGING COMMANDS

**Check environment variables:**
```powershell
echo $env:GEMINI_API_KEY
echo $env:OPENAI_API_KEY
echo $env:XAI_API_KEY
echo $env:OPENROUTER_API_KEY
```

**Test Gemini API directly:**
```powershell
curl -H "Content-Type: application/json" `
     -d '{"contents":[{"parts":[{"text":"Hello"}]}]}' `
     "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=$env:GEMINI_API_KEY"
```

---

*Generated by Multi-AI Orchestration System*  
*Claude 4.5 + Grok-4*  
*January 19, 2025*

