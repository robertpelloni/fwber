<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FWBer Auth + CORS Test</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; max-width: 900px; margin: 0 auto; }
    h1 { margin-bottom: 0; }
    .env { color: #555; margin: 8px 0 20px; }
    code { background:#f6f8fa; padding: 2px 6px; border-radius: 4px; }
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items: center; }
    input { padding:8px 10px; font-size:14px; }
    button { padding:10px 14px; font-size:14px; cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:6px; }
    button.primary { background:#0969da; color:#fff; border-color:#0969da; }
    button.danger { background:#d73a49; color:#fff; border-color:#d73a49; }
    .card { border:1px solid #e1e4e8; border-radius:8px; padding:16px; margin:14px 0; background:#fff; }
    pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; }
    .success { color: #1a7f37; }
    .error { color: #d1242f; }
    .muted { color:#6a737d; }
    .small { font-size:12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>FWBer Auth + CORS Test</h1>
  <div class="env">
    Frontend: <code>http://localhost:3000</code> &nbsp;•&nbsp; Backend: <code>http://localhost:8010/api</code>
  </div>

  <div class="card">
    <div class="row">
      <button onclick="ping()">Test Public Endpoint</button>
      <button onclick="testCors()">GET /matches/1/tier (no auth)</button>
      <button onclick="clearLog()">Clear</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="email" type="email" value="alice@test.com" placeholder="email" />
      <input id="password" type="password" value="password123" placeholder="password" />
      <button class="primary" onclick="login()">Login</button>
      <button onclick="me()">GET /user (auth)</button>
      <button onclick="tier()">GET /matches/1/tier (auth)</button>
      <button class="danger" onclick="logout()">Logout</button>
    </div>
    <div class="small muted" id="tokenStatus">No token</div>
  </div>

  <div class="card">
    <strong>Log</strong>
    <pre id="log"></pre>
  </div>

  <script>
    const API_URL = 'http://localhost:8010/api';

    function logLine(msg, cls = '') {
      const el = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const line = document.createElement('div');
      if (cls) line.className = cls;
      line.textContent = `[${time}] ${msg}`;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }
    function clearLog() { document.getElementById('log').innerHTML = ''; }
    function setTokenStatus() {
      const t = localStorage.getItem('fwber_token');
      document.getElementById('tokenStatus').textContent = t ? `Token set (${t.slice(0,8)}...)` : 'No token';
    }

    async function ping() {
      // There is no explicit public health route; this checks CORS surface by calling a known 401 endpoint and reading headers
      logLine('GET /matches/1/tier (expect 401) ...');
      const res = await fetch(`${API_URL}/matches/1/tier`);
      logLine(`Status: ${res.status}`);
      logCors(res);
      try { logJSON(await res.json()); } catch {}
    }

    async function testCors() {
      logLine('GET /matches/1/tier without auth ...');
      try {
        const res = await fetch(`${API_URL}/matches/1/tier`, { headers: { 'Accept': 'application/json' } });
        logLine(`Status: ${res.status}`);
        logCors(res);
        const data = await res.json();
        logJSON(data);
      } catch (e) { logLine(`Error: ${e.message}`, 'error'); }
    }

    async function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      logLine('POST /auth/login ...');
      try {
        const res = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        logLine(`Status: ${res.status}`);
        logCors(res);
        const data = await res.json();
        logJSON(data);
        if (res.ok && data.token) {
          localStorage.setItem('fwber_token', data.token);
          setTokenStatus();
          logLine('Token stored ✔', 'success');
        }
      } catch (e) { logLine(`Error: ${e.message}`, 'error'); }
    }

    async function me() {
      const token = localStorage.getItem('fwber_token');
      if (!token) return logLine('No token set', 'error');
      logLine('GET /user ...');
      try {
        const res = await fetch(`${API_URL}/user`, { headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' } });
        logLine(`Status: ${res.status}`);
        logCors(res);
        const data = await res.json();
        logJSON(data);
      } catch (e) { logLine(`Error: ${e.message}`, 'error'); }
    }

    async function tier() {
      const token = localStorage.getItem('fwber_token');
      if (!token) return logLine('No token set', 'error');
      logLine('GET /matches/1/tier ...');
      try {
        const res = await fetch(`${API_URL}/matches/1/tier`, { headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' } });
        logLine(`Status: ${res.status}`);
        logCors(res);
        const data = await res.json();
        logJSON(data);
      } catch (e) { logLine(`Error: ${e.message}`, 'error'); }
    }

    async function logout() {
      const token = localStorage.getItem('fwber_token');
      if (!token) return logLine('No token set', 'error');
      logLine('POST /auth/logout ...');
      try {
        const res = await fetch(`${API_URL}/auth/logout`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
        logLine(`Status: ${res.status}`);
        logCors(res);
        if (res.status === 204) {
          localStorage.removeItem('fwber_token');
          setTokenStatus();
          logLine('Logged out ✔', 'success');
        }
      } catch (e) { logLine(`Error: ${e.message}`, 'error'); }
    }

    function logCors(res) {
      const allowOrigin = res.headers.get('access-control-allow-origin');
      if (allowOrigin) logLine(`CORS allow-origin: ${allowOrigin}`, 'muted');
    }
    function logJSON(obj) {
      const s = JSON.stringify(obj, null, 2);
      logLine(s);
    }

    setTokenStatus();
    logLine('Ready. Use the buttons above to test public and authenticated calls.');
  </script>
</body>
</html>
